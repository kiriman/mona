"use strict";function getCookie(e){var t=document.cookie.match(new RegExp("(?:^|; )"+e.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g,"\\$1")+"=([^;]*)"));return t?decodeURIComponent(t[1]):void 0}function getCommentsRequest(){wrapper.innerHTML="Загрузка...";var e="onload"in new XMLHttpRequest?XMLHttpRequest:XDomainRequest,t=new e;t.withCredentials=!0,t.open("GET",SERVER_URL+"api/comments",!0),t.send(),t.onreadystatechange=function(){if(4==t.readyState)if(200!=t.status)console.error(t.status+": "+t.statusText);else{var e=JSON.parse(t.responseText);e.status&&(user.login=e.login,user.login||showHideAuthForm(""),user.isadmin=e.isadmin,comments=JSON.parse(e.data),renderAllComments(comments,e.isadmin))}}}function renderAllComments(e){wrapper.innerHTML="";for(var t=e.length-1;t>=0;t--){var n=document.createElement("div");n.className="panel panel-default",n.setAttribute("id","comment-"+e[t].id);var a=createCommentTemplate(e[t]);if(n.innerHTML=a,null!=e[t].image){var o=document.createElement("img");o.className="media-object",o.src=SERVER_URL+"uploads/"+e[t].image+"_min",n.getElementsByTagName("a")[0].appendChild(o),n.getElementsByTagName("a")[0].parentNode.classList.add("border")}if(user.isadmin){var s=document.createElement("div");s.className="panel-footer text-right",s.setAttribute("id","footer-"+e[t].id);var d=createFooterTemplate(e[t]);s.innerHTML=d,n.appendChild(s)}wrapper.appendChild(n)}}function createFooterTemplate(e){var t='\n		<div class="btn-group" data-toggle="buttons" >\n		  <label class="btn btn-default btn-xs '+ismoderatedBtnClass(e.is_moderated,1)+'" onclick="changeModerateState('+e.id+', 1)" >\n		    <input type="radio" name="options-'+e.id+'" id="option1-'+e.id+'" > принять\n		  </label>\n		  <label class="btn btn-default btn-xs '+ismoderatedBtnClass(e.is_moderated,2)+'" onclick="changeModerateState('+e.id+', 0)">\n		    <input type="radio" name="options-'+e.id+'" id="option2-'+e.id+'" > отклонить\n		  </label>\n		</div>';return t}function createCommentTemplate(e){var t='<div class="panel-heading">\n	        <div class="row">\n	          <div class="col-sm-6">\n	            <h3 class="panel-title"><b>'+e.name+"</b> ("+e.email+')</h3>\n	          </div>\n	          <div class="col-sm-6">\n	            <h5 class="panel-title add-date"><span class="admin-edit" id="isedited-'+e.id+'">'+isEdited(e.is_edited)+"</span> "+e.create_time+'</h5>\n	          </div>\n	        </div>\n	      </div>\n	      <div class="panel-body" >\n	      \n	      	  <div class="media">\n		        <pre class="media-body" onclick="startEditText(\''+e.id+'\')" id="text-'+e.id+'">'+e.text+'</pre>\n		        <div class="media-right media-top thumbnail-min">\n		          <a href="#" onclick="openImageModal(\''+e.id+'\')" data-toggle="modal" data-target="#modalImage">\n		            \n		          </a>\n		        </div>\n		      </div>\n\n	      </div>\n	      ';return t}function openImageModal(e){var t=document.createElement("img");t.className="thumbnail-full";var n=document.getElementById("comment-"+e).getElementsByTagName("img")[0].src;t.src=n.split("_")[0];for(var a=document.getElementById("modalImageBlock");a.firstChild;)a.removeChild(a.firstChild);a.appendChild(t)}function isEdited(e){return 1==e?"изменен администратором":""}function footerComment(){return user.isadmin?"block":"none"}function ismoderatedBtnClass(e,t){return 1==e&&1==t?"active":0==e&&2==t?"active":""}function ismoderatedBtnCheck(e,t){return 1==e&&1==t?"checked=true":0==e&&2==t?"checked=true":""}function changeModerateState(e,t){var n=JSON.stringify({id:e,is_moderated:t}),a="onload"in new XMLHttpRequest?XMLHttpRequest:XDomainRequest,o=new a;o.withCredentials=!0,o.open("PUT",SERVER_URL+"api/moderate",!0),o.send(n),o.onreadystatechange=function(){if(4==o.readyState)if(200!=o.status)console.error(o.status+": "+o.statusText);else{var e=JSON.parse(o.responseText);e.status}}}function editCommentTemplate(e,t){var n='<div class="panel-body">\n			<textarea class="form-control" id="newText" rows="3" placeholder="Текст" >'+t+'</textarea>\n			<p>\n			<div class="form-inline" style="text-align: right;">\n	    		<button class="btn btn-default" id="saveNewTextBtn" onclick="updateCommentsRequest(\''+e+'\')">Сохранить</button>\n	      		<button class="btn btn-default" id="cancelNewTextBtn" onclick="cancelEditText()">Отмена</button>\n      		</div>\n		</div>';return n}function startEditText(e){if(user.isadmin&&"preview"!==e&&!updateCommentsProc){null!=currentId&&cancelEditText(currentId),currentId=e;var t=document.getElementById("text-"+currentId);t.parentNode.parentNode.style.display="none";var n=document.createElement("div");n.innerHTML=editCommentTemplate(currentId,t.innerHTML),t.parentNode.parentNode.parentNode.lastChild.style.display="none",t.parentNode.parentNode.parentNode.appendChild(n)}}function cancelEditText(){var e=document.getElementById("text-"+currentId);e.parentNode.parentNode.style.display="block",e.parentNode.parentNode.parentNode.lastChild.remove(),e.parentNode.parentNode.parentNode.lastChild.style.display="block",currentId=null}function saveEditText(e){var t=document.getElementById("text-"+e),n=document.getElementById("newText").value;updateCommentsRequest(e,n)&&(t.innerHTML=n),t.style.display="block",t.parentNode.lastChild.remove()}function updateCommentsRequest(e){disableEditTextBlock(),updateCommentsProc=!0;var t=document.getElementById("text-"+e),n=document.getElementById("newText").value,a=JSON.stringify({id:e,newText:n}),o="onload"in new XMLHttpRequest?XMLHttpRequest:XDomainRequest,s=new o;s.withCredentials=!0,s.open("PUT",SERVER_URL+"api/comments",!0),s.send(a),s.onreadystatechange=function(){if(4==s.readyState){if(200!=s.status)console.error(s.status+": "+s.statusText);else{var e=JSON.parse(s.responseText);e.status&&(document.getElementById("isedited-"+currentId).innerHTML="изменен администратором...",currentId=null,t.innerHTML=n,t.parentNode.parentNode.style.display="block",t.parentNode.parentNode.parentNode.lastChild.remove(),t.parentNode.parentNode.parentNode.lastChild.style.display="block")}updateCommentsProc=!1}}}function disableEditTextBlock(){document.getElementById("newText").disabled=!0,document.getElementById("saveNewTextBtn").disabled=!0,document.getElementById("cancelNewTextBtn").disabled=!0}function enableEditTextBlock(){document.getElementById("newText").disabled=!1,document.getElementById("saveNewTextBtn").disabled=!1,document.getElementById("cancelNewTextBtn").disabled=!1}function getFormData(){var e=document.forms.feedback,t={name:e.elements.inputName.value,email:e.elements.inputEmail.value,text:e.elements.inputText.value,inputFile:e.elements.inputFile.value};return t}function clearFormData(){var e=document.forms.feedback;e.elements.inputName.value="",e.elements.inputEmail.value="",e.elements.inputText.value="",e.elements.inputFile.value=""}function preview(){if(validate()){document.getElementById("formGroupBtn").parentNode.className="col-sm-12";var e=getFormData();e.id="preview",e.create_time=(new Date).toLocaleString("ru");var t=document.createElement("div");t.className="panel panel-default",t.setAttribute("id","comment-preview");var n=createCommentTemplate(e);if(t.innerHTML=n,document.getElementById("preview").appendChild(t),void 0!=document.forms.feedback.inputFile.files[0]){var a=document.createElement("img");a.className="media-object",a.src=document.getElementById("inputImage").src,t.getElementsByTagName("a")[0].appendChild(a),t.getElementsByTagName("a")[0].parentNode.classList.add("border")}document.getElementById("form-feedback").style.display="none",document.getElementById("previewBtn").style.display="none",document.getElementById("cancelPreviewBtn").style.display="inline"}}function cancelPreview(){document.getElementById("comment-preview")&&(document.getElementById("formGroupBtn").parentNode.className="col-sm-8",document.getElementById("form-feedback").style.display="block",document.getElementById("comment-preview").remove(),document.getElementById("previewBtn").style.display="inline",document.getElementById("cancelPreviewBtn").style.display="none")}function addCommentRequest(){if(validate()){document.getElementById("addCommentBtn").disabled=!0,updateCommentsProc=!0;var e=document.forms.feedback.inputFile.files[0],t=getFormData(),n="onload"in new XMLHttpRequest?XMLHttpRequest:XDomainRequest,a=new n;a.withCredentials=!0,a.upload.onprogress=function(e){},a.open("POST",SERVER_URL+"api/comment",!0);var o=new FormData;o.append("image_file",e),o.append("name",t.name),o.append("email",t.email),o.append("text",t.text),a.send(o),a.onreadystatechange=function(){if(4==a.readyState){if(200!=a.status)console.error(a.status+": "+a.statusText);else{var e=JSON.parse(a.responseText);e.status&&(document.getElementById("successInfoBlock").style.display="block",clearFormData(),cancelPreview(),cancelImage(),user.isadmin&&getCommentsRequest())}document.getElementById("addCommentBtn").disabled=!1,updateCommentsProc=!1}}}}function getSigninFormData(){var e=document.forms.signin,t={login:e.elements.inputSigninLogin.value,password:e.elements.inputSigninPassword.value};return t}function signIn(){var e=getSigninFormData(),t=JSON.stringify(e),n="onload"in new XMLHttpRequest?XMLHttpRequest:XDomainRequest,a=new n;a.withCredentials=!0,a.open("POST",SERVER_URL+"api/signin",!0),a.send(t),a.onreadystatechange=function(){if(4==a.readyState)if(200!=a.status)console.error(a.status+": "+a.statusText);else{var e=JSON.parse(a.responseText);e.status?(user.login=e.login,user.session_id=e.session_id,document.cookie="userName="+user.login,showHideAuthForm(user.login),getCommentsRequest()):alert("Неверный Логин или Пароль !")}}}function signOut(){document.cookie="userName=";var e="onload"in new XMLHttpRequest?XMLHttpRequest:XDomainRequest,t=new e;t.withCredentials=!0,t.open("GET",SERVER_URL+"api/signout",!0),t.send(),t.onreadystatechange=function(){if(4==t.readyState)if(200!=t.status)console.error(t.status+": "+t.statusText);else{var e=JSON.parse(t.responseText);e.status?(user.login="",user.session_id="",document.cookie="userName=",showHideAuthForm(user.login),getCommentsRequest()):alert("Ошибка.")}}}function showHideAuthForm(e){""!=e?(document.getElementById("userLogin").innerHTML=user.login,document.getElementById("form-signin").style.display="none",document.getElementById("form-signout").style.display="block"):(document.getElementById("userLogin").innerHTML=user.login,document.getElementById("form-signin").style.display="block",document.getElementById("form-signout").style.display="none")}function removeErrorClass(e){e.parentNode.parentNode.className="form-group"}function removeAllErrorClass(){for(var e=document.forms.feedback.getElementsByClassName("form-group"),t=e.length-1;t>=0;t--)e[t].className="form-group"}function validate(){removeAllErrorClass();var e=[];e.status=!0;var t=/[a-zа-яё]+/i,n=/\S+@\S+\.\S+/,a=getFormData();return null==t.exec(a.name)&&!function(){var t=document.getElementById("inputName");t.parentNode.parentNode.classList.add("has-error"),t.addEventListener("click",function(){removeErrorClass(t)}),e.status=!1}(),null==n.exec(a.email)&&!function(){var t=document.getElementById("inputEmail");t.parentNode.parentNode.classList.add("has-error"),t.addEventListener("click",function(){removeErrorClass(t)}),e.status=!1}(),""==a.text.replace(/\s/g,"")&&!function(){var t=document.getElementById("inputText");t.parentNode.parentNode.classList.add("has-error"),t.addEventListener("click",function(){removeErrorClass(t)}),e.status=!1}(),!!e.status}function getFile(){document.getElementById("inputFile").click()}function cancelImage(){document.getElementById("inputFile").value="",document.getElementById("inputImagePlaceholder").style.display="table-cell",document.getElementById("cancelImageBtn").style.display="none",document.getElementById("inputImage").style.display="none",document.getElementById("inputImage").src=""}function sortComments(e){COMPARE_TYPE=getCompareType(e);var t=document.getElementById("chevron");if(e.id==t.parentNode.id)"glyphicon glyphicon-chevron-up"==t.className?(t.className="glyphicon glyphicon-chevron-down",comments.sort(compareUp)):(t.className="glyphicon glyphicon-chevron-up",comments.sort(compareDown));else{t.remove();var t=document.createElement("span");t.className="glyphicon glyphicon-chevron-down",t.setAttribute("id","chevron"),e.appendChild(t),comments.sort(compareUp)}renderAllComments(comments)}function getCompareType(e){var t="";return"colName"==e.id&&(t="name"),"colEmail"==e.id&&(t="email"),"colDate"==e.id&&(t="create_time"),t}function compareUp(e,t){return e[COMPARE_TYPE]>t[COMPARE_TYPE]?1:e[COMPARE_TYPE]<t[COMPARE_TYPE]?-1:0}function compareDown(e,t){return t[COMPARE_TYPE]>e[COMPARE_TYPE]?1:t[COMPARE_TYPE]<e[COMPARE_TYPE]?-1:0}document.addEventListener("DOMContentLoaded",getCommentsRequest);var SERVER_URL="https://operun.herokuapp.com/",wrapper=document.getElementById("wrapper"),comments=[],currentId=null,updateCommentsProc=!1,user={login:getCookie("userName")||"",isadmin:!1,session_id:""},COMPARE_TYPE="create_type";showHideAuthForm(user.login),document.getElementById("inputFile").addEventListener("change",function(e){document.forms.feedback.inputFile.files[0];document.getElementById("inputImagePlaceholder").style.display="none",document.getElementById("cancelImageBtn").style.display="inline",document.getElementById("inputImage").style.display="inline";var t=e.target.files[0],n=document.getElementById("inputImage"),a=new FileReader;a.onload=function(e){n.src=e.target.result},a.readAsDataURL(t)},!1);
//# sourceMappingURL=main.min.js.map
